<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Tictoc Tutorial: 2. Enhancing the 2-node TicToc</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.6 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<h1><a class="anchor" name="part2">2. Enhancing the 2-node TicToc</a></h1>PREV: <a class="el" href="part1.html">1. Getting started</a> UP: <a class="el" href="index.html#contents">Contents</a><h2><a class="anchor" name="s2">
Step 2: Refining the graphics, and adding debugging output</a></h2>
Here we make the model look a bit prettier in the GUI. We assign the "block/process" icon (the file <code>bitmaps/block/process.gif</code>), and paint it cyan for tic and yellow for toc. This is achieved by adding display strings to the NED file. The <code>i=</code> tag in the display string specifies the icon.<p>
 <div class="fragment"><pre class="fragment">    submodules:
        tic: <a class="code" href="classTxc2.html">Txc2</a>;
            display: <span class="stringliteral">"i=block/process,cyan"</span>; <span class="comment">// Note "i=&lt;icon&gt;,&lt;color&gt;"</span>
        toc: <a class="code" href="classTxc2.html">Txc2</a>;
            display: <span class="stringliteral">"i=block/process,gold"</span>; <span class="comment">// Here too</span>
    connections:
</pre></div><p>
You can see the result here:<p>
<div align="center">
<img src="step2a.gif" alt="step2a.gif">
</div>
<p>
We also modify the C++ file to add some debug messages to <a class="el" href="classTxc1.html">Txc1</a> by writing to the OMNeT++ <code>ev</code> object like this:<p>
 <div class="fragment"><pre class="fragment">        <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Sending initial message\n"</span>;
</pre></div><p>
and<p>
<div class="fragment"><pre class="fragment">    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Received message `"</span> &lt;&lt; msg-&gt;name() &lt;&lt; <span class="stringliteral">"', sending it out again\n"</span>;
</pre></div><p>
When you run the simulation in the OMNeT++ GUI Tkenv, the following output will appear in the main text window:<p>
<div align="center">
<img src="step2b.gif" alt="step2b.gif">
</div>
<p>
You can also open separate output windows for tic and toc by right-clicking on their icons and choosing Module output from the menu. This feature will be useful when you have a large model ("fast scrolling logs syndrome") and you're interested only in the log messages of specific module.<p>
<div align="center">
<img src="step2c.gif" alt="step2c.gif">
</div>
<p>
Sources: <a class="el" href="tictoc2.ned.html">tictoc2.ned</a>, <a class="el" href="txc2.cc.html">txc2.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s3">
Step 3: Adding state variables</a></h2>
In this step we add a counter to the module, and delete the message after ten exchanges.<p>
We add the counter as a class member:<p>
 <div class="fragment"><pre class="fragment"><span class="keyword">class </span><a class="code" href="classTxc3.html">Txc3</a> : <span class="keyword">public</span> <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html">cSimpleModule</a>
{
  <span class="keyword">private</span>:
    <span class="keywordtype">int</span> counter;  <span class="comment">// Note the counter here</span>

  <span class="keyword">protected</span>:
</pre></div><p>
We set the variable to 10 in initialize() and decrement in handleMessage(), that is, on every message arrival. After it reaches zero, the simulation will run out of events and terminate.<p>
Note the<p>
 <div class="fragment"><pre class="fragment">    WATCH(counter);
</pre></div><p>
line in the source: this makes it possible to see the counter value in Tkenv. Double-click on tic's icon, then choose the Contents page from the inspector window that pops up.<p>
<div align="center">
<img src="step3.gif" alt="step3.gif">
</div>
<p>
As you continue running the simulation, you can follow as the counter keeps decrementing until it reaches zero.<p>
Sources: <a class="el" href="tictoc3.ned.html">tictoc3.ned</a>, <a class="el" href="txc3.cc.html">txc3.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s4">
Step 4: Adding parameters</a></h2>
In this step you'll learn how to add input parameters to the simulation: we'll turn the "magic number" 10 into a parameter.<p>
Module parameters have to be declared in the NED file. The data type can be numeric, string, bool, or xml (the latter is for easy access to XML config files), among others.<p>
 <div class="fragment"><pre class="fragment">simple <a class="code" href="classTxc4.html">Txc4</a>
    parameters:
        limit: numeric <span class="keyword">const</span>;  <span class="comment">// declare the new parameter</span>
    gates:
</pre></div><p>
We also have to modify the C++ code to read the parameter in initialize(), and assign it to the counter.<p>
 <div class="fragment"><pre class="fragment">    counter = par(<span class="stringliteral">"limit"</span>);
</pre></div><p>
Now, we can assign the parameters in the NED file or from omnetpp.ini. Assignments in the NED file take precedence. Typically you'll want to leave most parameter assigments to omnetpp.ini because it makes the model a lot more flexible.<p>
Here, we assign one parameter in the NED file:<p>
 <div class="fragment"><pre class="fragment"><span class="comment">// Adding module parameters.</span>
<span class="comment">//</span>
module Tictoc4
    submodules:
        tic: <a class="code" href="classTxc4.html">Txc4</a>;
            parameters:
                limit = 8;  <span class="comment">// tic's limit is 8</span>
            display: <span class="stringliteral">"i=block/process,cyan"</span>;
        toc: <a class="code" href="classTxc4.html">Txc4</a>;
            <span class="comment">// note that we leave toc's limit unbound here</span>
            display: <span class="stringliteral">"i=block/process,gold"</span>;
    connections:
</pre></div><p>
and the other in omnetpp.ini:<p>
 <div class="fragment"><pre class="fragment">tictoc4.toc.limit = 5
</pre></div><p>
Note that because omnetpp.ini supports wildcards, and parameters assigned from NED files take precedence over the ones in omnetpp.ini, we could have used<p>
<div class="fragment"><pre class="fragment">tictoc4.t*c.limit=5
</pre></div><p>
or<p>
<div class="fragment"><pre class="fragment">tictoc4.*.limit=5
</pre></div><p>
or even<p>
<div class="fragment"><pre class="fragment">**.limit=5
</pre></div><p>
with the same effect. (The difference between * and ** is that * will not match a dot and ** will.)<p>
In Tkenv, you can inspect module parameters either in the object tree on the left-hand side of the main window, or in the Parameters page of the module inspector (opened via double-clicking on the module icon).<p>
The module with the smaller limit will delete the message and thereby conclude the simulation.<p>
Sources: <a class="el" href="tictoc4.ned.html">tictoc4.ned</a>, <a class="el" href="txc4.cc.html">txc4.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s5">
Step 5: Modelling processing delay</a></h2>
In the previous models, tic and toc immediately sent back the received message. Here we'll add some timing: tic and toc will hold the message for 1 simulated second before sending it back. In OMNeT++ such timing is achieved by the module sending a message to itself. Such messages are called self-messages (but only because of the way they are used, otherwise they are ordinary message objects).<p>
We added two <a class="elRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> * variables, <code>event</code> and <code>tictocMsg</code> to the class, to remember the message we use for timing and message whose processing delay we are simulating.<p>
 <div class="fragment"><pre class="fragment"><span class="keyword">class </span><a class="code" href="classTxc5.html">Txc5</a> : <span class="keyword">public</span> <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html">cSimpleModule</a>
{
  <span class="keyword">private</span>:
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *event; <span class="comment">// pointer to the event object which we'll use for timing</span>
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *tictocMsg; <span class="comment">// variable to remember the message until we send it back</span>

  <span class="keyword">public</span>:
</pre></div><p>
We "send" the self-messages with the scheduleAt() function, specifying when it should be delivered back to the module.<p>
 <div class="fragment"><pre class="fragment">        scheduleAt(simTime()+1.0, event);
</pre></div><p>
In handleMessage() now we have to differentiate whether a new message has arrived via the input gate or the self-message came back (timer expired). Here we are using<p>
 <div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span> (msg==event)
</pre></div><p>
but we could have written<p>
<div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
</pre></div><p>
as well.<p>
We have left out the counter, to keep the source code small.<p>
The result of running the simulation can be seen below.<p>
<div align="center">
<img src="step5.gif" alt="step5.gif">
</div>
<p>
Sources: <a class="el" href="tictoc5.ned.html">tictoc5.ned</a>, <a class="el" href="txc5.cc.html">txc5.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s6">
Step 6: Random numbers and parameters</a></h2>
In this step we'll introduce random numbers. We change the delay from 1s to a random value which can be set from the NED file or from omnetpp.ini. Module parameters are able to return random variates; however, to make use of this feature we have to read the parameter in handleMessage() every time we use it.<p>
 <div class="fragment"><pre class="fragment">            <span class="comment">// The "delayTime" module parameter can be set to values like</span>
            <span class="comment">// "exponential(5)" (tictoc6.ned, omnetpp.ini), and then here</span>
            <span class="comment">// we'll get a different delay every time.</span>
            <span class="keywordtype">double</span> delay = par(<span class="stringliteral">"delayTime"</span>);

            <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Message arrived, starting to wait "</span> &lt;&lt; delay &lt;&lt; <span class="stringliteral">" secs...\n"</span>;
            tictocMsg = msg;
            scheduleAt(simTime()+delay, event);
</pre></div><p>
In addition, we'll "lose" (delete) the packet with a small (hardcoded) probability.<p>
 <div class="fragment"><pre class="fragment">        <span class="keywordflow">if</span> (uniform(0,1) &lt; 0.1)
        {
            <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"\"Losing\" message\n"</span>;
            <span class="keyword">delete</span> msg;
        }
</pre></div><p>
We'll assign the parameters in omnetpp.ini:<p>
 <div class="fragment"><pre class="fragment">tictoc6.tic.delayTime = exponential(3)
tictoc6.toc.delayTime = truncnormal(3,1)
</pre></div><p>
You can try that no matter how many times you re-run the simulation (or restart it, Simulate|Rebuild network menu item), you'll get exactly the same results. This is because OMNeT++ uses a deterministic algorithm (by default the Mersenne Twister RNG) to generate random numbers, and initializes it to the same seed. This is important for reproducible simulations. You can experiment with different seeds if you add the following lines to omnetpp.ini:<p>
<div class="fragment"><pre class="fragment">[General]
seed-0-mt=532569  # or any other 32-bit value
</pre></div><p>
From the syntax you have probably guessed that OMNeT++ supports more than one RNGs. That's right, however, all models in this tutorial use RNG 0.<p>
<em>Exercise: Try other distributions as well. </em><p>
Sources: <a class="el" href="tictoc6.ned.html">tictoc6.ned</a>, <a class="el" href="txc6.cc.html">txc6.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s7">
Step 7: Timeout, cancelling timers</a></h2>
In order to get one step closer to modelling networking protocols, let us transform our model into a stop-and-wait simulation. This time we'll have separate classes for tic and toc. The basic scenario is similar to the previous ones: tic and toc will be tossing a message to one another. However, toc will "lose" the message with some nonzero probability, and in that case tic will have to resend it.<p>
Here's toc's code:<p>
 <div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="classToc7.html#a5cfeb5a376ec0ceb459dc21f078f200">Toc7::handleMessage</a>(<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *msg)
{
    <span class="keywordflow">if</span> (uniform(0,1) &lt; 0.1)
    {
        <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"\"Losing\" message.\n"</span>;
        <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcModule.html#f4bae90f598f10f280713b6e6340d0c4">bubble</a>(<span class="stringliteral">"message lost"</span>);  <span class="comment">// making animation more informative...</span>
        <span class="keyword">delete</span> msg;
    }
    <span class="keywordflow">else</span>
</pre></div><p>
Thanks to the bubble() call in the code, toc'll display a callout whenever it drops the message.<p>
<div align="center">
<img src="step7.gif" alt="step7.gif">
</div>
<p>
So, tic will start a timer whenever it sends the message. When the timer expires, we'll assume the message was lost and send another one. If toc's reply arrives, the timer has to be cancelled. The timer will be (what else?) a self-message.<p>
 <div class="fragment"><pre class="fragment">        scheduleAt(simTime()+timeout, timeoutEvent);
</pre></div><p>
Cancelling the timer will be done with the cancelEvent() call. Note that this does not prevent us from being able to reuse the same timeout message over and over.<p>
 <div class="fragment"><pre class="fragment">        cancelEvent(timeoutEvent);
</pre></div><p>
You can read Tic's full source in <a class="el" href="txc7.cc.html">txc7.cc</a>.<p>
Sources: <a class="el" href="tictoc7.ned.html">tictoc7.ned</a>, <a class="el" href="txc7.cc.html">txc7.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s8">
Step 8: Retransmitting the same message</a></h2>
In this step we refine the previous model. There we just created another packet if we needed to retransmit. This is OK because the packet didn't contain much, but in real life it's usually more practical to keep a copy of the original packet so that we can re-send it without the need to build it again.<p>
What we do here is keep the original packet and send only copies of it. We delete the original when toc's acknowledgement arrives. To make it easier to visually verify the model, we'll include a message sequence number the message names.<p>
In order to avoid handleMessage() growing too large, we'll put the corresponding code into two new functions, generateNewMessage() and sendCopyOf() and call them from handleMessage().<p>
The functions:<p>
 <div class="fragment"><pre class="fragment"><a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *<a class="code" href="classTic8.html#c286a49132f7df562cdb8fd325215eee">Tic8::generateNewMessage</a>()
{
    <span class="comment">// Generate a message with a different name every time.</span>
    <span class="keywordtype">char</span> msgname[20];
    sprintf(msgname, <span class="stringliteral">"tic-%d"</span>, ++<a class="code" href="classTic8.html#78d16cff5ce524c6f3e105086c702bc3">seq</a>);
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *msg = <span class="keyword">new</span> <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcObject.html#d3256010e27eef8502a2337eea2ceedd">cMessage</a>(msgname);
    <span class="keywordflow">return</span> msg;
}
</pre></div><p>
 <div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="classTic8.html#f5b73eaf49de4eb8b94160ccad26c504">Tic8::sendCopyOf</a>(<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *msg)
{
    <span class="comment">// Duplicate message and send the copy.</span>
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *copy = (<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html">cMessage</a> *) msg-&gt;<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcMessage.html#9afd48d053b1334b9d1afde1830f2937">dup</a>();
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html#03a9558a2c1f86db6e079fc25e7799d6">send</a>(copy, <span class="stringliteral">"out"</span>);
}
</pre></div><p>
Sources: <a class="el" href="tictoc8.ned.html">tictoc8.ned</a>, <a class="el" href="txc8.cc.html">txc8.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><p>
NEXT: <a class="el" href="part3.html">3. Turning it into a real network</a> <hr size="1"><address style="align: right;"><small>Generated on Sun Nov 19 13:30:42 2006 for Tictoc Tutorial by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6 </small></address>
</body>
</html>
