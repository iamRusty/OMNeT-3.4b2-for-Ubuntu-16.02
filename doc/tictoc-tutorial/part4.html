<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Tictoc Tutorial: 4. Adding statistics collection</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.6 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="dirs.html"><span>Directories</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<h1><a class="anchor" name="part4">4. Adding statistics collection</a></h1>PREV: <a class="el" href="part3.html">3. Turning it into a real network</a> UP: <a class="el" href="index.html#contents">Contents</a><h2><a class="anchor" name="s11">
Step 11: Displaying the number of packets sent/received</a></h2>
To get an overview at runtime how many messages each node sent or received, we've added two counters to the module class: numSent and numReceived.<p>
 <div class="fragment"><pre class="fragment"><span class="keyword">class </span><a class="code" href="classTxc11.html">Txc11</a> : <span class="keyword">public</span> <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html">cSimpleModule</a>
{
  <span class="keyword">private</span>:
    <span class="keywordtype">long</span> numSent;
    <span class="keywordtype">long</span> numReceived;

  <span class="keyword">protected</span>:
</pre></div><p>
They are set to zero and WATCH'ed in the initialize() method. Now we can use the Find/inspect objects dialog (Inspect menu; it is also on the toolbar) to learn how many packets were sent or received by the various nodes.<p>
<div align="center">
<img src="step11a.gif" alt="step11a.gif">
</div>
<p>
It's true that in this concrete simulation model the numbers will be roughly the same, so you can only learn from them that intuniform() works properly. But in real-life simulations it can be very useful that you can quickly get an overview about the state of various nodes in the model.<p>
It can be also arranged that this info appears above the module icons. The <code>t=</code> display string tag specifies the text; we only need to modify the displays string during runtime. The following code does the job:<p>
 <div class="fragment"><pre class="fragment">        <span class="keywordflow">if</span> (<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcEnvir.html#c43b7c9a14dd1433a0883515843fd252">isGUI</a>())
            updateDisplay();
</pre></div><p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="classTxc11.html#b9de72719c7fdb0d6ef75c055d06910d">Txc11::updateDisplay</a>()
{
    <span class="keywordtype">char</span> buf[40];
    sprintf(buf, <span class="stringliteral">"rcvd: %ld sent: %ld"</span>, <a class="code" href="classTxc11.html#8f717ab0463e7ff25c75358865fcda93">numReceived</a>, <a class="code" href="classTxc11.html#4fb32573688627213859643bcf8a125b">numSent</a>);
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcModule.html#186e796472e9c12de0f7efc375547b3a">displayString</a>().<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcDisplayString.html#c28ad4dd38f9cacab66d6c08a89adf61">setTagArg</a>(<span class="stringliteral">"t"</span>,0,buf);
}
</pre></div><p>
And the result looks like this:<p>
<div align="center">
<img src="step11b.gif" alt="step11b.gif">
</div>
<p>
Sources: <a class="el" href="tictoc11.ned.html">tictoc11.ned</a>, <a class="el" href="tictoc11.msg.html">tictoc11.msg</a>, <a class="el" href="txc11.cc.html">txc11.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><h2><a class="anchor" name="s12">
Step 12: Adding statistics collection</a></h2>
The previous simulation model does something interesting enough so that we can collect some statistics. For example, you may be interested in the average hop count a message has to travel before reaching its destination.<p>
We'll record in the hop count of every message upon arrival into an output vector (a sequence of (time,value) pairs, sort of a time series). We also calculate mean, standard deviation, minimum, maximum values per node, and write them into a file at the end of the simulation. Then we'll use off-line tools to analyse the output files.<p>
For that, we add an output vector object (which will record the data into omnetpp.vec) and a histogram object (which also calculates mean, etc) to the class.<p>
 <div class="fragment"><pre class="fragment"><span class="keyword">class </span><a class="code" href="classTxc12.html">Txc12</a> : <span class="keyword">public</span> <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html">cSimpleModule</a>
{
  <span class="keyword">private</span>:
    <span class="keywordtype">long</span> <a class="code" href="classTxc12.html#77ff6f82b5b82b27d7afd04cb4b28e43">numSent</a>;
    <span class="keywordtype">long</span> <a class="code" href="classTxc12.html#6bd54be78df4e6446ad6f76e4e5ae44e">numReceived</a>;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcLongHistogram.html">cLongHistogram</a> <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcOutVector.html">cOutVector</a> <a class="code" href="classTxc12.html#3aa7be7e37e55e5c39c24349d65817f0">hopCountVector</a>;

  <span class="keyword">protected</span>:
</pre></div><p>
When a message arrives at the destination node, we update the statistics. The following code has been added to handleMessage():<p>
<div class="fragment"><pre class="fragment">        <a class="code" href="classTxc12.html#3aa7be7e37e55e5c39c24349d65817f0">hopCountVector</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcOutVector.html#273992ba4303875ea69b0aacacb34edc">record</a>(hopcount);
        <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcLongHistogram.html#b1d3c844514adcd3524150346537ed19">collect</a>(hopcount);
</pre></div><p>
hopCountVector.record() call writes the data into omnetpp.vec. With a large simulation model or long execution time, the omnetpp.vec file may grow very large. To handle this situation, you can specifically disable/enable vector in omnetpp.ini, and you can also specify a simulation time interval in which you're interested (data recorded outside this interval will be discarded.)<p>
When you begin a new simulation, the existing omnetpp.vec file gets deleted.<p>
Scalar data (collected by the histogram object in this simulation) have to be recorded manually, in the finish() function. finish() gets invoked on successful completion of the simulation, i.e. not when it's stopped with an error. The recordScalar() calls in the code below write into the omnetpp.sca file.<p>
<div class="fragment"><pre class="fragment"><span class="keywordtype">void</span> <a class="code" href="classTxc12.html#0ed41abe7ccef1e1bf7278d08d765e51">Txc12::finish</a>()
{
    <span class="comment">// This function is called by OMNeT++ at the end of the simulation.</span>
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Sent:     "</span> &lt;&lt; numSent &lt;&lt; endl;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Received: "</span> &lt;&lt; numReceived &lt;&lt; endl;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Hop count, min:    "</span> &lt;&lt; <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcStdDev.html#8f8cddd189c5a9c39fe63ed66ba5d275">min</a>() &lt;&lt; endl;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Hop count, max:    "</span> &lt;&lt; <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcStdDev.html#c2c833a1189c4ce811cd8322bd1cc417">max</a>() &lt;&lt; endl;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Hop count, mean:   "</span> &lt;&lt; <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcStdDev.html#350d0d5cea8f395312235a7ecdfa160b">mean</a>() &lt;&lt; endl;
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//group__Envir.html#g3cf804e7182ab12879c33c914e1c5cd8">ev</a> &lt;&lt; <span class="stringliteral">"Hop count, stddev: "</span> &lt;&lt; <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcStdDev.html#7db0471173e9af9326c4002512499420">stddev</a>() &lt;&lt; endl;

    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html#e26f7792d74d2c9e163edd1b41f90db9">recordScalar</a>(<span class="stringliteral">"#sent"</span>, numSent);
    <a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcSimpleModule.html#e26f7792d74d2c9e163edd1b41f90db9">recordScalar</a>(<span class="stringliteral">"#received"</span>, numReceived);
    <a class="code" href="classTxc12.html#b7a82795b09af11ac1ee0e044e643bc4">hopCountStats</a>.<a class="codeRef" doxygen="opptags.xml:../api//" href="../api//classcStatistic.html#3cd4c113fb16af07168e7991344ca75e">recordScalar</a>(<span class="stringliteral">"hop count"</span>);
}
</pre></div><p>
Unlike omnetpp.vec, omnetpp.sca is <em>not</em> deleted between simulation runs. Instead, new data are just appended to it. The idea is that you can collect output from several simulation runs (i.e. with different input parameters), and analyse them together.<p>
It is possible to use different file names (omnetpp.ini option) so that e.g. multiple runs write to different files.<p>
You can also view the data during simulation. In the module inspector's Contents page you'll find the hopCountStats and hopCountVector objects, and you can open their inspectors (double-click). They will be initially empty -- run the simulation in Fast (or even Express) mode to get enough data to be displayed. After a while you'll get something like this:<p>
<div align="center">
<img src="step12a.gif" alt="step12a.gif">
</div>
<p>
<div align="center">
<img src="step12b.gif" alt="step12b.gif">
</div>
<p>
When you think enough data has been collected, you can stop the simulation and then we'll analyse the result files (omnetpp.vec and omnetpp.sca) off-line. You'll need to choose Simulate|Call finish() from the menu (or click the corresponding toolbar button) before exiting -- this will cause the finish() functions to run and data to be written into omnetpp.sca.<p>
Sources: <a class="el" href="tictoc12.ned.html">tictoc12.ned</a>, <a class="el" href="tictoc12.msg.html">tictoc12.msg</a>, <a class="el" href="txc12.cc.html">txc12.cc</a>, <a class="el" href="omnetpp.ini.html">omnetpp.ini</a><p>
NEXT: <a class="el" href="part5.html">5. Visualizing the results with Plove and Scalars</a> <hr size="1"><address style="align: right;"><small>Generated on Sun Nov 19 13:30:42 2006 for Tictoc Tutorial by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.6 </small></address>
</body>
</html>
